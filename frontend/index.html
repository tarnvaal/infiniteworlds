<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PersistentDM</title>
    <style>
      /* minimal styles for chat */
      #chat-app { max-width: 720px; margin: 1rem auto; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .chat-container { border: 1px solid #ddd; border-radius: 8px; padding: 0.75rem; }
      #messages { height: 320px; overflow-y: auto; padding: 0.5rem; background: #fafafa; border-radius: 6px; }
      .msg { padding: 0.4rem 0.6rem; margin: 0.35rem 0; border-radius: 6px; white-space: pre-wrap; }
      .msg.user { background: #e6f0ff; align-self: flex-end; }
      .msg.bot { background: #f1f1f1; }
      #chat-form { display: flex; gap: 0.5rem; margin-top: 0.6rem; }
      #message-input { flex: 1; padding: 0.55rem 0.7rem; border: 1px solid #ccc; border-radius: 6px; }
      #send-btn { padding: 0.55rem 0.9rem; border: 1px solid #0d6efd; background: #0d6efd; color: #fff; border-radius: 6px; cursor: pointer; }
      #send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="chat-app">
      <div class="chat-container">
        <div id="messages"></div>
        <form id="chat-form">
          <input id="message-input" type="text" placeholder="Type a message and press Enterâ€¦" autocomplete="off" />
          <button id="send-btn" type="submit">Send</button>
        </form>
      </div>
    </div>
    <script>
      (function () {
        const apiBase = 'http://localhost:8000';
        const messagesEl = document.getElementById('messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        /** @type {{role: 'user'|'assistant', content: string}[]} */
        const history = [];

        function render() {
          messagesEl.innerHTML = '';
          for (const item of history) {
            const div = document.createElement('div');
            div.className = `msg ${item.role === 'user' ? 'user' : 'bot'}`;
            div.textContent = (item.role === 'user' ? 'You: ' : 'Bot: ') + item.content;
            messagesEl.appendChild(div);
          }
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const text = input.value;
          history.push({ role: 'user', content: text });
          render();
          input.value = '';
          input.focus();
          sendBtn.disabled = true;
          try {
            const res = await fetch(`${apiBase}/chat`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: text }),
            });
            if (!res.ok) {
              let errMsg = res.statusText || 'Request failed';
              try {
                const err = await res.json();
                if (err && err.detail && err.detail.message) errMsg = err.detail.message;
              } catch (_) {}
              history.push({ role: 'assistant', content: `[Error] ${errMsg}` });
            } else {
              const data = await res.json();
              history.push({ role: 'assistant', content: data.reply });
            }
          } catch (err) {
            history.push({ role: 'assistant', content: `[Network error] ${String(err)}` });
          } finally {
            render();
            sendBtn.disabled = false;
          }
        });
      })();
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
  </html>
